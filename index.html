<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown語法神轉換系統</title>
    <!-- Font Awesome CSS CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" />
    <!-- marked.js for Markdown to HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- FileSaver.js for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- PptxGenJS for PPTX generation -->
    <script src="https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <!-- docx.js for Word document generation -->
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .preview-content {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            background: #ffffff;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .preview-content h1 { font-size: 1.75rem; font-weight: 700; margin: 1rem 0 0.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.25rem; }
        .preview-content h2 { font-size: 1.5rem; font-weight: 600; margin: 1rem 0 0.5rem; border-bottom: 1px solid #e5e7eb; }
        .preview-content h3 { font-size: 1.25rem; font-weight: 600; margin: 0.8rem 0 0.4rem; }
        .preview-content p { margin-bottom: 0.8rem; line-height: 1.6; }
        .preview-content ul, .preview-content ol { margin-left: 1.5rem; margin-bottom: 0.8rem; }
        .preview-content ul { list-style-type: disc; }
        .preview-content ol { list-style-type: decimal; }
        .preview-content blockquote { border-left: 4px solid #4b6cb7; padding-left: 1rem; margin: 0 0 0.8rem; color: #4b5568; font-style: italic; }
        .preview-content pre {
            background: #1f2937;
            color: #e5e7eb;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
        }
        .preview-content code {
            background: #f3f4f6;
            color: #4b6cb7;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 85%;
        }
        .preview-content pre code { background: transparent; padding: 0; }
        .preview-content table { border-collapse: collapse; width: 100%; margin-bottom: 1rem; border: 1px solid #e5e7eb; }
        .preview-content th, .preview-content td { border: 1px solid #e5e7eb; padding: 0.5rem 0.75rem; text-align: left; }
        .preview-content th { background: #f3f4f6; font-weight: 600; }
        .preview-content tr:nth-child(even) { background: #f9fafb; }
        .preview-content img { max-width: 100%; height: auto; margin: 0.5rem 0; border-radius: 0.5rem; }
        .preview-content hr { border: none; border-top: 1px solid #e5e7eb; margin: 1.5rem 0; }
        .btn-primary {
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            background: #4b6cb7;
            color: white;
            border-radius: 0.5rem;
        }
        .btn-primary:hover { background: #3b5998; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            border-bottom: none;
            margin-bottom: -1px;
            background: #f3f4f6;
        }
        .tab-button.active { background: #ffffff; color: #4b6cb7; border-color: #e5e7eb; }
        .tab-button.inactive { background: #e5e7eb; color: #6b7280; }
        .tab-button.inactive:hover { background: #d1d5db; }
        .preview-pane { display: none; }
        .preview-pane.active { display: block; }
        .placeholder-content {
            padding: 1rem;
            border: 2px dashed #e5e7eb;
            border-radius: 0.5rem;
            background: #ffffff;
            color: #6b7280;
        }
        .placeholder-content p { margin-bottom: 0.5rem; }
        .placeholder-content ul { margin: 0.5rem 0 0 1.25rem; list-style-type: disc; }
        .placeholder-content code { background: #f3f4f6; color: #4b6cb7; padding: 0.1em 0.3em; border-radius: 4px; font-size: 0.8em; }
        #syntax-guide-container { display: flex; gap: 1.5rem; }
        #syntax-guide-nav { width: 220px; flex-shrink: 0; }
        #syntax-guide-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
            background: #ffffff;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        #syntax-guide-nav li a {
            display: block;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.25rem;
            color: #6b7280;
            text-decoration: none;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            word-break: break-word;
        }
        #syntax-guide-nav li a:hover, #syntax-guide-nav li a.active {
            background: #f3f4f6;
            color: #4b6cb7;
            font-weight: 500;
        }
        #syntax-content {
            flex-grow: 1;
            max-height: 600px;
            overflow-y: auto;
            scroll-padding-top: 1rem;
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        #syntax-content h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #4b6cb7;
            margin: 1.5rem 0 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e5e7eb;
            scroll-margin-top: 1rem;
        }
        #syntax-content h4:first-child { margin-top: 0; }
        .syntax-textarea {
            width: 100%;
            background: #1f2937;
            color: #e5e7eb;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            resize: none;
            border: none;
            margin-top: 0.5rem;
            transition: box-shadow 0.2s ease;
        }
        .syntax-textarea:hover { box-shadow: 0 0 0 2px #e5e7eb; }
        .syntax-textarea:focus { outline: none; box-shadow: 0 0 0 2px #4b6cb7; }
        .copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #4b6cb7;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            margin-top: 0.5rem;
        }
        .copy-btn:hover { background: #3b5998; transform: translateY(-1px); }
        .copy-btn.copied { background: #2f855a; }
        .syntax-section { margin-bottom: 2rem; }
        @media (max-width: 768px) {
            #syntax-guide-container { flex-direction: column; }
            #syntax-guide-nav { width: 100%; position: static; max-height: none; }
            #syntax-guide-nav ul { display: flex; flex-wrap: wrap; gap: 0.5rem; }
            #syntax-guide-nav li a { padding: 0.3rem 0.5rem; font-size: 0.85rem; }
        }

        /* --- NEW: Mascot Styles --- */
        #mascot {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 120px;
            height: auto;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 999;
        }
        #mascot:hover {
            transform: scale(1.15) rotate(-8deg);
            animation: mascot-shake 0.5s infinite alternate;
        }
        .particle {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1001; /* Above other elements */
            transition: transform 1s ease-out, opacity 1s ease-out;
        }
        @keyframes mascot-shake {
            0% { transform: scale(1.15) rotate(-8deg); }
            100% { transform: scale(1.15) rotate(8deg); }
        }
        @media (max-width: 768px) {
            #mascot {
                width: 80px;
                bottom: 15px;
                left: 15px;
            }
        }
    </style>
</head>
<body class="bg-white min-h-screen text-gray-900">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Markdown 語法神轉換系統</h1>
            <p class="text-lg text-gray-600">將 Markdown 輕鬆轉為 HTML、Word (.docx) 及 PPT (.pptx)</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Section -->
            <section class="bg-gray-100 rounded-xl shadow-md p-6 flex flex-col">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">輸入 Markdown</h2>
                <textarea
                    id="markdown-input"
                    class="w-full flex-grow p-4 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 bg-white text-base leading-relaxed font-mono resize-none transition-all duration-300"
                    placeholder="在此輸入 Markdown 語法... (或參考下方說明)"
                    rows="20"
                ></textarea>
                <div class="mt-4 text-right">
                    <button id="convert-btn" class="btn-primary font-semibold text-lg focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 shadow-md">
                        <i class="fas fa-sync-alt mr-2"></i> 轉換預覽
                    </button>
                </div>
            </section>

            <!-- Preview Section -->
            <section class="bg-gray-100 rounded-xl shadow-md p-6 flex flex-col">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">預覽與下載</h2>
                <div class="flex mb-0 border-b border-gray-200">
                    <button id="html-tab" class="tab-button active"><i class="fas fa-code mr-2"></i>HTML 預覽</button>
                    <button id="word-tab" class="tab-button inactive ml-1"><i class="fas fa-file-word mr-2"></i>Word 選項</button>
                    <button id="ppt-tab" class="tab-button inactive ml-1"><i class="fas fa-file-powerpoint mr-2"></i>PPT 選項</button>
                </div>

                <div id="preview-container" class="flex-grow mt-0">
                    <!-- HTML Preview Pane -->
                    <div id="html-preview-pane" class="preview-pane active">
                        <div id="html-preview" class="preview-content">
                            <p class="text-gray-500 italic p-4 text-center">點擊「轉換預覽」按鈕來查看結果</p>
                        </div>
                    </div>
                    <!-- Word Preview Pane -->
                    <div id="word-preview-pane" class="preview-pane">
                        <div class="preview-content">
                            <div class="placeholder-content">
                                <p class="font-semibold text-lg text-gray-800">Word 文件 (.docx) 下載</p>
                                <p>點擊「下載 Word」按鈕，將 Markdown 轉為 <code>.docx</code> 文件。</p>
                                <p class="font-medium mt-3">轉換說明：</p>
                                <ul>
                                    <li>保留標題、段落、列表、粗體/斜體、表格等格式。</li>
                                    <li>圖片需為公開 URL，否則可能無法轉換。</li>
                                    <li>複雜 CSS 樣式可能簡化。</li>
                                    <li>程式碼區塊轉為單一字體文字。</li>
                                </ul>
                                <p class="mt-3 text-sm text-red-500 font-medium">注意：客戶端轉換效果有限，請檢查輸出文件。</p>
                            </div>
                        </div>
                    </div>
                    <!-- PPT Preview Pane -->
                    <div id="ppt-preview-pane" class="preview-pane">
                        <div class="preview-content">
                            <div class="placeholder-content">
                                <p class="font-semibold text-lg text-gray-800">PPT 文件 (.pptx) 下載</p>
                                <p>點擊「下載 PPT」按鈕，將 Markdown 轉為 <code>.pptx</code> 文件。</p>
                                <p class="font-medium mt-3">投影片生成規則：</p>
                                <ul>
                                    <li><code># H1</code> 或 <code>---</code> 開始新投影片。</li>
                                    <li><code>## H2</code> 作為內容標題。</li>
                                    <li>段落、列表、表格、程式碼區塊加入內容區。</li>
                                    <li>表格和程式碼區塊格式可能簡化。</li>
                                </ul>
                                <p class="mt-3 text-sm text-red-500 font-medium">注意：依賴 Markdown 結構，請檢查輸出簡報。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-200 flex flex-wrap justify-center gap-3">
                    <button id="download-html" class="btn-primary font-medium focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 shadow-md">
                        <i class="fas fa-file-code mr-2"></i> 下載 HTML
                    </button>
                    <button id="download-word" class="btn-primary font-medium focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 shadow-md">
                        <i class="fas fa-file-word mr-2"></i> 下載 Word
                    </button>
                    <button id="download-ppt" class="btn-primary font-medium focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 shadow-md">
                        <i class="fas fa-file-powerpoint mr-2"></i> 下載 PPT
                    </button>
                </div>
            </section>
        </div>

        <section class="mt-10 bg-gray-100 rounded-xl shadow-md p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-5 text-center">Markdown 語法說明</h2>
            <div id="syntax-guide-container">
                <nav id="syntax-guide-nav">
                    <p class="text-sm font-semibold text-gray-600 mb-2">快速導覽：</p>
                    <ul>
                        <li><a href="#md-headings">標題 (H1-H6)</a></li>
                        <li><a href="#md-paragraphs">段落與換行</a></li>
                        <li><a href="#md-text-styles">字體效果</a></li>
                        <li><a href="#md-blockquotes">引文</a></li>
                        <li><a href="#md-lists">列表 (有序/無序)</a></li>
                        <li><a href="#md-nested-lists">巢狀列表</a></li>
                        <li><a href="#md-links">連結</a></li>
                        <li><a href="#md-autolinks">簡易超連結</a></li>
                        <li><a href="#md-ref-links">參考連結</a></li>
                        <li><a href="#md-hr">分隔線</a></li>
                        <li><a href="#md-code">程式碼</a></li>
                        <li><a href="#md-images">圖片</a></li>
                        <li><a href="#md-image-links">圖片連結</a></li>
                        <li><a href="#md-tables">表格</a></li>
                        <li><a href="#md-task-lists">核取方塊</a></li>
                        <li><a href="#md-escaping">跳脫字元</a></li>
                        <li><a href="#md-html">內嵌 HTML</a></li>
                    </ul>
                </nav>

                <div id="syntax-content">
                    <div class="syntax-section" id="md-headings">
                        <h4>標題 (Headings H1-H6)</h4>
                        <textarea class="syntax-textarea" rows="10" data-textarea-id="md-headings"># 這是一級標題 (H1)
## 這是二級標題 (H2)
### 這是三級標題 (H3)
#### 這是四級標題 (H4)
##### 這是五級標題 (H5)
###### 這是六級標題 (H6)

H1 標題替代語法
===============

H2 標題替代語法
---------------</textarea>
                        <button class="copy-btn" data-textarea-id="md-headings"><i class="fas fa-copy mr-2"></i> 複製</button>
                    </div>
                    <div class="syntax-section" id="md-paragraphs">
                        <h4>段落與換行 (Paragraphs & Breaks)</h4>
                        <textarea class="syntax-textarea" rows="8" data-textarea-id="md-paragraphs">這是第一個段落。單一換行不分段。
這仍是第一段。

空行開始新段落。

這是第二段。

行尾兩個空格加 Enter 強制換行。  
像這樣。</textarea>
                        <button class="copy-btn" data-textarea-id="md-paragraphs"><i class="fas fa-copy mr-2"></i> 複製</button>
                    </div>
                    <div class="syntax-section" id="md-text-styles">
                        <h4>字體效果 (Emphasis)</h4>
                        <textarea class="syntax-textarea" rows="4" data-textarea-id="md-text-styles">*斜體* 或 _斜體_
**粗體** 或 __粗體__
***粗斜體*** 或 ___粗斜體___
~~刪除線~~</textarea>
                        <button class="copy-btn" data-textarea-id="md-text-styles"><i class="fas fa-copy mr-2"></i> 複製</button>
                    </div>
                    <div class="syntax-section" id="md-blockquotes">
                        <h4>引文 (Blockquotes)</h4>
                        <textarea class="syntax-textarea" rows="8" data-textarea-id="md-blockquotes">> 引文區塊。
> 可多行。
>
>> 巢狀引文。
>
> ### 引文內 Markdown
> - 列表
> - `程式碼`</textarea>
                        <button class="copy-btn" data-textarea-id="md-blockquotes"><i class="fas fa-copy mr-2"></i> 複製</button>
                    </div>
                    <div class="syntax-section" id="md-lists">
                        <h4>列表 (Lists)</h4>
                        <textarea class="syntax-textarea" rows="8" data-textarea-id="md-lists">無序列表:
* 項目一
* 項目二
  + 子項目
- 項目三

有序列表:
1. 第一項
2. 第二項
   1. 子項目
8. 數字不必連續</textarea>
                        <button class="copy-btn" data-textarea-id="md-lists"><i class="fas fa-copy mr-2"></i> 複製</button>
                    </div>
                    <div class="syntax-section" id="md-nested-lists">
                        <h4>巢狀列表 (Nested Lists)</h4>
                        <textarea class="syntax-textarea" rows="6" data-textarea-id="md-nested-lists">- 層級 1
  - 層級 2
    - 層級 3
      1. 層級 4
    * 層級 3b
* 層級 1b</textarea>
                        <button class="copy-btn" data-textarea-id="md-nested-lists"><i class="fas fa-copy mr-2"></i> 複製</button>
                    </div>
                    <div class="syntax-section" id="md-links">
                        <h4>連結 (Links)</h4>
                        <textarea class="syntax-textarea" rows="2" data-textarea-id="md-links">[連結文字](https://google.com "標題")
[無標題](https://github.com)</textarea>
                        <button class="copy-btn" data-textarea-id="md-links"><i class="fas fa-copy mr-2"></i> 複製</button>
                    </div>
                    <div class="syntax-section" id="md-autolinks">
                        <h4>簡易超連結 (Autolinks)</h4>
                        <textarea class="syntax-textarea" rows="2" data-textarea-id="md-autolinks"><https://example.com>
<email@example.com></textarea>
                        <button class="copy-btn" data-textarea-id="md-autolinks"><i class="fas fa-copy mr-2"></i> 複製</button>
                    </div>
                    <div class="syntax-section" id="md-ref-links">
                        <h4>參考連結 (Reference Links)</h4>
                        <textarea class="syntax-textarea" rows="6" data-textarea-id="md-ref-links">[標籤一][1]
[標籤二]
[Google][]

[1]: https://mozilla.org 'MDN'
[標籤二]: https://wikipedia.org
[Google]: https://google.com</textarea>
                        <button class="copy-btn" data-textarea-id="md-ref-links"><i class="fas fa-copy mr-2"></i> 複製</button>
                    </div>
                    <div class="syntax-section" id="md-hr">
                        <h4>分隔線 (Horizontal Rules)</h4>
                        <textarea class="syntax-textarea" rows="3" data-textarea-id="md-hr">---
***
___</textarea>
                        <button class="copy-btn" data-textarea-id="md-hr"><i class="fas fa-copy mr-2"></i> 複製</button>
                    </div>
                    <div class="syntax-section" id="md-code">
                        <h4>程式碼 (Code)</h4>
                        <textarea class="syntax-textarea" rows="8" data-textarea-id="md-code">行內: `var x = 10;`

程式碼區塊:
```javascript
function greet(name) {
  console.log(`Hello, ${name}!`);
}

縮排程式碼
行二</textarea>
                    <button class="copy-btn" data-textarea-id="md-code"><i class="fas fa-copy mr-2"></i> 複製</button>
                </div>
                <div class="syntax-section" id="md-images">
                    <h4>圖片 (Images)</h4>
                    <textarea class="syntax-textarea" rows="4" data-textarea-id="md-images">![替代文字](https://via.placeholder.com/150 "標題")
![logo](https://via.placeholder.com/50</textarea>)
<button class="copy-btn" data-textarea-id="md-images"><i class="fas fa-copy mr-2"></i> 複製</button>
</div>
<div class="syntax-section" id="md-image-links">
<h4>圖片連結 (Linked Images)</h4>
<textarea class="syntax-textarea" rows="1" data-textarea-id="md-image-links">
![alt text](https://via.placeholder.com/80)
</textarea>
<button class="copy-btn" data-textarea-id="md-image-links"><i class="fas fa-copy mr-2"></i> 複製</button>
</div>
<div class="syntax-section" id="md-tables">
<h4>表格 (Tables)</h4>
<textarea class="syntax-textarea" rows="4" data-textarea-id="md-tables">| 標題 1 | 標題 2 | 置中 | 靠右 |
| :------ | :------ | :----: | ------: |
| 內容 1 | 長內容 | 中間 | 右對齊 |
| 程式碼| 斜體 | 粗體 | 文字 |</textarea>
<button class="copy-btn" data-textarea-id="md-tables"><i class="fas fa-copy mr-2"></i> 複製</button>
</div>
<div class="syntax-section" id="md-task-lists">
<h4>核取方塊 (Task Lists)</h4>
<textarea class="syntax-textarea" rows="3" data-textarea-id="md-task-lists">- [x] 已完成
未完成
子任務</textarea>
<button class="copy-btn" data-textarea-id="md-task-lists"><i class="fas fa-copy mr-2"></i> 複製</button>
</div>
<div class="syntax-section" id="md-escaping">
<h4>跳脫字元 (Escaping)</h4>
<textarea class="syntax-textarea" rows="4" data-textarea-id="md-escaping">*星星*
`code`
# 非標題
\ 反斜線</textarea>
<button class="copy-btn" data-textarea-id="md-escaping"><i class="fas fa-copy mr-2"></i> 複製</button>
</div>
<div class="syntax-section" id="md-html">
<h4>內嵌 HTML (Inline HTML)</h4>
<textarea class="syntax-textarea" rows="3" data-textarea-id="md-html"><div style="color: blue;">
藍色文字
</div></textarea>
<button class="copy-btn" data-textarea-id="md-html"><i class="fas fa-copy mr-2"></i> 複製</button>
</div>
</div>
</div>
</section>
    <footer class="text-center mt-10 text-gray-600 text-sm">
        Copyright © Liyuchiutiger Gongminshen
    </footer>
</div>

<!-- NEW: Mascot Element -->
<img id="mascot" src="image/LiyuChillGuy.svg" alt="LiyuChillGuy Mascot">

<script type="text/javascript">
    // This script block seems to be related to a different functionality (XLSX parsing) and is not used by the main script.
    // It's kept here as it was in the original file, but it does not affect the Markdown converter.
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
        return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                var filteredData = jsonData.filter(row => row.some(filledCell));
                var headerRowIndex = filteredData.findIndex((row, index) =>
                    row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                    headerRowIndex = 0;
                }
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
    }
</script>

<script>
    (function() {
        'use strict';

        const state = {
            currentHtmlContent: '',
            cachedTokens: null,
            isConverting: false,
            initialPlaceholder: '<p class="text-gray-500 italic p-4 text-center">點擊「轉換預覽」按鈕來查看結果</p>'
        };

        const elements = {
            markdownInput: document.getElementById('markdown-input'),
            convertBtn: document.getElementById('convert-btn'),
            htmlPreview: document.getElementById('html-preview'),
            downloadHtmlBtn: document.getElementById('download-html'),
            downloadWordBtn: document.getElementById('download-word'),
            downloadPptBtn: document.getElementById('download-ppt'),
            htmlTab: document.getElementById('html-tab'),
            wordTab: document.getElementById('word-tab'),
            pptTab: document.getElementById('ppt-tab'),
            htmlPreviewPane: document.getElementById('html-preview-pane'),
            wordPreviewPane: document.getElementById('word-preview-pane'),
            pptPreviewPane: document.getElementById('ppt-preview-pane'),
            syntaxNavLinks: document.querySelectorAll('#syntax-guide-nav a'),
            copyButtons: document.querySelectorAll('.copy-btn'),
            mascot: document.getElementById('mascot') // NEW: Mascot element
        };

        const libraries = {
            marked: typeof marked !== 'undefined' ? marked : null,
            FileSaver: typeof saveAs !== 'undefined' ? saveAs : null,
            PptxGenJS: typeof PptxGenJS !== 'undefined' ? PptxGenJS : null,
            Docx: typeof docx !== 'undefined' ? docx : null
        };

        function init() {
            console.log('Marked:', !!libraries.marked);
            console.log('FileSaver:', !!libraries.FileSaver);
            console.log('PptxGenJS:', !!libraries.PptxGenJS);
            console.log('Docx:', !!libraries.Docx);

            if (!libraries.marked) {
                showError('Marked.js 未載入，無法解析 Markdown。');
                disableButtons();
                return;
            }
            if (!libraries.FileSaver) { showError('FileSaver.js 未載入，無法下載文件。'); elements.downloadHtmlBtn.disabled = true; elements.downloadWordBtn.disabled = true; elements.downloadPptBtn.disabled = true; }
            if (!libraries.Docx) { showError('docx.js 未載入，Word 轉換將不可用。'); elements.downloadWordBtn.disabled = true; }
            if (!libraries.PptxGenJS) { showError('PptxGenJS 未載入，PPT 轉換將不可用。'); elements.downloadPptBtn.disabled = true; }

            libraries.marked.setOptions({ breaks: true, gfm: true, pedantic: false, sanitize: false });
            elements.htmlPreview.innerHTML = state.initialPlaceholder;
            checkFontAwesome();
            bindEvents();
        }

        function checkFontAwesome() {
            const testIcon = document.createElement('i');
            testIcon.className = 'fas fa-sync-alt';
            document.body.appendChild(testIcon);
            const isLoaded = window.getComputedStyle(testIcon, ':before').content !== '';
            document.body.removeChild(testIcon);
            if (!isLoaded) { showError('Font Awesome 圖標未成功加載。'); }
        }

        function disableButtons() {
            elements.convertBtn.disabled = true;
            elements.downloadHtmlBtn.disabled = true;
            elements.downloadWordBtn.disabled = true;
            elements.downloadPptBtn.disabled = true;
        }

        function bindEvents() {
            elements.convertBtn.addEventListener('click', handleConversion);
            elements.markdownInput.addEventListener('input', debounce(handleConversion, 400));
            elements.htmlTab.addEventListener('click', () => switchTab('html'));
            elements.wordTab.addEventListener('click', () => switchTab('word'));
            elements.pptTab.addEventListener('click', () => switchTab('ppt'));
            elements.downloadHtmlBtn.addEventListener('click', downloadHtml);
            elements.downloadWordBtn.addEventListener('click', downloadWord);
            elements.downloadPptBtn.addEventListener('click', downloadPpt);

            elements.syntaxNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        elements.syntaxNavLinks.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });

            elements.copyButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const textareaId = btn.getAttribute('data-textarea-id');
                    const textarea = document.querySelector(`textarea[data-textarea-id="${textareaId}"]`);
                    if (textarea) {
                        navigator.clipboard.writeText(textarea.value.trim())
                            .then(() => {
                                btn.classList.add('copied');
                                btn.innerHTML = '<i class="fas fa-check mr-2"></i> 已複製';
                                setTimeout(() => {
                                    btn.classList.remove('copied');
                                    btn.innerHTML = '<i class="fas fa-copy mr-2"></i> 複製';
                                }, 2000);
                            })
                            .catch(err => showError(`複製失敗: ${err.message}`));
                    } else {
                        showError('無法找到文字框。');
                    }
                });
            });
            
            // NEW: Mascot event listener
            elements.mascot.addEventListener('click', (e) => {
                for (let i = 0; i < 30; i++) {
                    createParticle(e.clientX, e.clientY);
                }
            });
        }

        function debounce(fn, delay) {
            let timer;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        async function handleConversion() {
            if (state.isConverting) return;
            state.isConverting = true;
            setButtonState(elements.convertBtn, true, '轉換中...');
            try {
                const markdownText = elements.markdownInput.value; // Keep whitespace for parsing
                if (!markdownText.trim()) {
                    state.currentHtmlContent = '';
                    state.cachedTokens = null;
                    elements.htmlPreview.innerHTML = state.initialPlaceholder;
                } else {
                    state.currentHtmlContent = libraries.marked.parse(markdownText);
                    state.cachedTokens = libraries.marked.lexer(markdownText);
                    elements.htmlPreview.innerHTML = state.currentHtmlContent || state.initialPlaceholder;
                }
            } catch (error) {
                showError(`Markdown 解析錯誤: ${error.message}`);
                elements.htmlPreview.innerHTML = `<p class="text-red-600 p-4">解析錯誤: ${error.message}</p>`;
                state.currentHtmlContent = '';
                state.cachedTokens = null;
            } finally {
                state.isConverting = false;
                setButtonState(elements.convertBtn, false, '轉換預覽');
            }
        }

        function switchTab(tabName) {
            const tabs = { html: elements.htmlTab, word: elements.wordTab, ppt: elements.pptTab };
            const panes = { html: elements.htmlPreviewPane, word: elements.wordPreviewPane, ppt: elements.pptPreviewPane };
            Object.values(tabs).forEach(tab => tab.classList.replace('active', 'inactive'));
            Object.values(panes).forEach(pane => pane.classList.remove('active'));
            tabs[tabName].classList.replace('inactive', 'active');
            panes[tabName].classList.add('active');
        }

        function downloadHtml() {
            if (!libraries.FileSaver) { showError('FileSaver.js 未載入！'); return; }
            if (!state.currentHtmlContent || elements.htmlPreview.innerHTML === state.initialPlaceholder) { showError('請先轉換 Markdown！'); return; }
            setButtonState(elements.downloadHtmlBtn, true, '下載中...');
            try {
                const fullHtml = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><title>Markdown Export</title><style>body{font-family:'Inter',system-ui,sans-serif;line-height:1.6;padding:2rem;max-width:800px;margin:2rem auto;color:#1f2937;}h1,h2,h3{color:#111827;}h1{font-size:2em;border-bottom:2px solid #e5e7eb;}h2{font-size:1.5em;border-bottom:1px solid #e5e7eb;}blockquote{border-left:4px solid #d1d5db;padding-left:1em;color:#4b5568;font-style:italic;}pre{background-color:#1f2937;color:#f9fafb;padding:1em;border-radius:0.5rem;overflow-x:auto;}code{font-family:monospace;background-color:#f3f4f6;padding:0.2em 0.4em;border-radius:4px;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #d1d5db;padding:0.5em 1em;}th{background-color:#f9fafb;}img{max-width:100%;height:auto;border-radius:0.5rem;}</style></head><body>${state.currentHtmlContent}</body></html>`;
                const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' });
                libraries.FileSaver(blob, 'markdown_export.html');
            } catch (error) { showError(`HTML 下載錯誤: ${error.message}`); }
            finally { setButtonState(elements.downloadHtmlBtn, false, '下載 HTML'); }
        }

        // --- OPTIMIZED WORD EXPORT ---
        async function downloadWord() {
            if (!libraries.Docx || !libraries.FileSaver) { showError('所需函式庫未載入，無法下載 Word！'); return; }
            if (!state.cachedTokens) { showError('請先輸入並轉換 Markdown！'); return; }

            setButtonState(elements.downloadWordBtn, true, '轉換中...');
            try {
                const { Document, Packer, Paragraph, TextRun, HeadingLevel, Table, TableRow, TableCell, WidthType, BorderStyle, ShadingType, AlignmentType, Indent } = libraries.Docx;
                const children = [];

                const FONT = "Calibri";
                const THEME_COLOR = "4B6CB7";

                state.cachedTokens.forEach(token => {
                    try {
                        switch (token.type) {
                            case 'heading':
                                children.push(new Paragraph({
                                    heading: `Heading${token.depth}`,
                                    children: [new TextRun({ text: token.text, font: FONT, size: 44 - token.depth * 4, bold: true })],
                                    spacing: { after: 120 },
                                }));
                                break;
                            case 'paragraph':
                                children.push(new Paragraph({
                                    children: [new TextRun({ text: token.text, font: FONT, size: 22 })],
                                    spacing: { after: 120 },
                                    alignment: AlignmentType.LEFT
                                }));
                                break;
                            case 'list':
                                token.items.forEach(item => {
                                    children.push(new Paragraph({
                                        children: [new TextRun({ text: item.text, font: FONT, size: 22 })],
                                        bullet: { level: 0 },
                                        indent: { left: 720, hanging: 360 },
                                        spacing: { after: 60 }
                                    }));
                                });
                                break;
                            case 'code':
                                children.push(new Paragraph({
                                    children: [new TextRun({ text: token.text, font: "Courier New", size: 20 })],
                                    shading: { type: ShadingType.SOLID, color: "F3F4F6" },
                                    border: { top: { style: BorderStyle.SINGLE, size: 4, color: "E5E7EB" }, bottom: { style: BorderStyle.SINGLE, size: 4, color: "E5E7EB" }, left: { style: BorderStyle.SINGLE, size: 4, color: "E5E7EB" }, right: { style: BorderStyle.SINGLE, size: 4, color: "E5E7EB" } },
                                    spacing: { before: 200, after: 200 },
                                    indent: { left: 200, right: 200 }
                                }));
                                break;
                            case 'table':
                                children.push(new Table({
                                    width: { size: 100, type: WidthType.PERCENTAGE },
                                    rows: [
                                        new TableRow({
                                            children: token.header.map(cell => new TableCell({
                                                children: [new Paragraph({ children: [new TextRun({ text: cell.text, bold: true, color: "FFFFFF", font: FONT, size: 22 })], alignment: AlignmentType.CENTER })],
                                                shading: { type: ShadingType.SOLID, color: THEME_COLOR },
                                                borders: { top: { style: BorderStyle.NONE }, bottom: { style: BorderStyle.SINGLE, size: 6, color: THEME_COLOR }, left: { style: BorderStyle.NONE }, right: { style: BorderStyle.NONE } }
                                            }))
                                        }),
                                        ...token.rows.map((row, rowIndex) => new TableRow({
                                            children: row.map(cell => new TableCell({
                                                children: [new Paragraph({ children: [new TextRun({ text: cell.text, font: FONT, size: 22 })] })],
                                                shading: { type: ShadingType.SOLID, color: rowIndex % 2 === 0 ? "FFFFFF" : "F9FAFB" },
                                                borders: { top: { style: BorderStyle.NONE }, bottom: { style: BorderStyle.NONE }, left: { style: BorderStyle.NONE }, right: { style: BorderStyle.NONE } }
                                            }))
                                        }))
                                    ]
                                }));
                                children.push(new Paragraph({ text: '' })); // Add space after table
                                break;
                            case 'blockquote':
                                children.push(new Paragraph({
                                    children: [new TextRun({ text: token.text, italics: true, color: "555555", font: FONT, size: 22 })],
                                    indent: { left: 720 },
                                    border: { left: { style: BorderStyle.SINGLE, size: 8, color: THEME_COLOR, space: 4 } },
                                    spacing: { before: 100, after: 100 }
                                }));
                                break;
                            case 'hr':
                                children.push(new Paragraph({ border: { bottom: { color: "auto", space: 1, value: "single", size: 6 } }, spacing: { before: 240, after: 240 } }));
                                break;
                        }
                    } catch (e) { console.error(`Error processing token ${token.type}:`, e); }
                });

                const doc = new Document({ sections: [{ children }] });
                const blob = await Packer.toBlob(doc);
                libraries.FileSaver(blob, 'markdown_export.docx');
            } catch (error) { showError(`Word 轉換錯誤: ${error.message}`); console.error('Word conversion error:', error); }
            finally { setButtonState(elements.downloadWordBtn, false, '下載 Word'); }
        }

        // --- OPTIMIZED PPT EXPORT ---
        async function downloadPpt() {
            if (!libraries.PptxGenJS || !libraries.FileSaver) { showError('所需函式庫未載入，無法下載 PPT！'); return; }
            if (!state.cachedTokens) { showError('請先輸入並轉換 Markdown！'); return; }
            setButtonState(elements.downloadPptBtn, true, '生成中...');
            
            try {
                const pptx = new libraries.PptxGenJS();
                pptx.layout = 'LAYOUT_16x9';
                const THEME_COLOR = "4B6CB7";
                const TEXT_COLOR = "333333";
                const BG_COLOR = "FFFFFF";
                const FONT_FACE = "Inter";

                const TITLE_STYLE = { x: 0.5, y: 0.5, w: '90%', h: 1.0, fontSize: 36, bold: true, color: THEME_COLOR, align: 'center', fontFace: FONT_FACE };
                const SUBTITLE_STYLE = { x: 0.5, y: 1.5, w: '90%', fontSize: 20, color: '666666', align: 'center', fontFace: FONT_FACE };
                const SLIDE_TITLE_STYLE = { x: 0.5, y: 0.25, w: '90%', h: 0.75, fontSize: 32, bold: true, color: THEME_COLOR, fontFace: FONT_FACE };
                const BODY_STYLE = { x: 0.5, y: 1.2, w: '90%', h: 5.0, fontSize: 18, color: TEXT_COLOR, fontFace: FONT_FACE, lineSpacing: 28 };
                const CODE_STYLE = { x: 0.5, y: 1.2, w: '90%', h: 5.0, fill: { color: "F3F4F6" }, fontFace: "Courier New", fontSize: 12, color: "1F2937", lineSpacing: 20 };

                let slide = null;
                let y = BODY_STYLE.y;

                function newSlide(title) {
                    slide = pptx.addSlide();
                    slide.background = { color: BG_COLOR };
                    if (title) {
                        slide.addText(title, SLIDE_TITLE_STYLE);
                    }
                    y = BODY_STYLE.y;
                }
                
                // Handle title slide automatically
                const firstH1Index = state.cachedTokens.findIndex(t => t.type === 'heading' && t.depth === 1);
                if(firstH1Index !== -1) {
                    const titleToken = state.cachedTokens[firstH1Index];
                    newSlide();
                    slide.addText(titleToken.text, TITLE_STYLE);

                    const nextToken = state.cachedTokens[firstH1Index + 1];
                    if (nextToken && nextToken.type === 'paragraph') {
                        slide.addText(nextToken.text, SUBTITLE_STYLE);
                    }
                } else {
                    newSlide("簡報");
                }

                state.cachedTokens.forEach((token, index) => {
                     if (index <= firstH1Index || (firstH1Index !== -1 && index === firstH1Index + 1 && state.cachedTokens[index].type === 'paragraph')) {
                        return; // Skip tokens used for title slide
                    }

                    if ((token.type === 'heading' && token.depth === 1) || token.type === 'hr') {
                         newSlide(token.type === 'heading' ? token.text : null);
                         return;
                    }

                    if (!slide) newSlide();
                    
                    // Check for overflow before adding content
                    if (y > 5.5) newSlide();

                    switch (token.type) {
                        case 'heading':
                            slide.addText(token.text, { ...BODY_STYLE, y, fontSize: 28 - token.depth * 2, bold: true, h: 0.5 });
                            y += 0.6;
                            break;
                        case 'paragraph':
                            slide.addText(token.text, { ...BODY_STYLE, y, h: (token.text.length / 80 + 1) * 0.4 });
                            y += (token.text.length / 80 + 1) * 0.4;
                            break;
                        case 'list':
                            const listItems = token.items.map(item => ({ text: item.text }));
                            slide.addText(listItems, { ...BODY_STYLE, y, bullet: { type: token.ordered ? 'number' : 'bullet' }, h: token.items.length * 0.4 });
                            y += token.items.length * 0.4;
                            break;
                        case 'code':
                            slide.addText(token.text, { ...CODE_STYLE, y, h: (token.text.split('\n').length * 0.3) + 0.2 });
                            y += (token.text.split('\n').length * 0.3) + 0.3;
                            break;
                        case 'table':
                            const tableRows = [token.header.map(cell => ({ text: cell.text, options: { bold: true, fill: THEME_COLOR, color: "FFFFFF", align: 'center' } })), ...token.rows.map(row => row.map(cell => cell.text))];
                            slide.addTable(tableRows, { x: 0.5, y, w: '90%', rowband_odd: { fill: 'F9FAFB' }, border: { type: 'solid', pt: 1, color: 'CCCCCC' } });
                            y += tableRows.length * 0.4;
                            break;
                    }
                });

                // Add a concluding slide
                const finalSlide = pptx.addSlide();
                finalSlide.background = { color: 'F3F4F6' };
                finalSlide.addText('感謝聆聽', { ...TITLE_STYLE, color: TEXT_COLOR, y: '40%' });
                
                await pptx.writeFile({ fileName: 'markdown_export.pptx' });
            } catch (error) {
                showError(`PPT 生成錯誤: ${error.message}`);
                console.error('PPT generation error:', error);
            } finally {
                setButtonState(elements.downloadPptBtn, false, '下載 PPT');
            }
        }

        function setButtonState(button, isLoading, text) {
            button.disabled = isLoading;
            const iconClass = isLoading ? 'fa-spinner fa-spin' : button.querySelector('i').className.split(' ').filter(c => c !== 'fa-spinner' && c !== 'fa-spin').join(' ');
            button.innerHTML = `<i class="${iconClass} mr-2"></i>${text}`;
        }

        function showError(message) {
            alert(message);
            console.error(message);
        }
        
        // NEW: Mascot particle effect function
        function createParticle(x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            document.body.appendChild(particle);
            const colors = ['#4b6cb7', '#3b5998', '#1f2937', '#e5e7eb', '#6b7280'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            particle.style.background = color;
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            const destinationX = (Math.random() - 0.5) * 300;
            const destinationY = (Math.random() - 0.5) * 300;
            const rotation = Math.random() * 520;
            requestAnimationFrame(() => {
                particle.style.transform = `translate(${destinationX}px, ${destinationY}px) rotate(${rotation}deg)`;
                particle.style.opacity = '0';
            });
            setTimeout(() => { particle.remove(); }, 1000);
        }

        document.addEventListener('DOMContentLoaded', init);
    })();
</script>
</body>
</html>

